#!/usr/bin/env bash

set -euo pipefail

pyproject_changed=$(git diff --name-only ORIG_HEAD HEAD -- pyproject.toml 2>/dev/null || true)

if [ -n "$pyproject_changed" ]; then
    echo ""
    echo "pyproject.toml changed - reinstalling package..."
    uv sync --reinstall-package ai-agent-rules
    echo "Package reinstalled successfully."
    echo ""
fi

new_config_files=$(git diff --name-status --diff-filter=A ORIG_HEAD HEAD -- config/ 2>/dev/null | grep '^A' || true)

if [ -n "$new_config_files" ]; then
    echo ""
    echo "New config files detected - running 'uv run ai-rules install --rebuild-cache'..."
    echo ""
    echo "New files added:"
    echo "$new_config_files" | sed 's/^A[[:space:]]*/  - /'
    echo ""
    if uv run ai-rules install --rebuild-cache; then
        echo "Symlinks updated successfully."
    else
        echo "Warning: ai-rules install failed. Run 'uv run ai-rules install --rebuild-cache' manually."
    fi
    echo ""
fi

exit 0
